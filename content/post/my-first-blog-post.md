---
title:       "ç¬¬ä¸€ç¯‡åšæ–‡ï¼Œçºªå¿µä¸€ä¸‹"
description: "å‡ ç»æ³¢æŠ˜åï¼Œåšå®¢ç»ˆäºç¨³å®šä¸‹æ¥äº†ï¼Œå‡ å¹´ä¸€ä¸‹"
date:        2022-02-23
author:      "æ¢å¤©"
image:       ""
tags:        ["life"]
categories:  ["life" ]
---

è¿™æ˜¯æ–°åšå®¢çš„ç¬¬ä¸€ç¯‡åšæ–‡ï¼Œå¾ˆæœ‰çºªå¿µæ„ä¹‰ï¼Œä¹Ÿè®¸å¤šå¹´åå›æ¥å†çœ‹ï¼Œè¿™é‡Œå°±æ˜¯æ¢¦å¼€å§‹çš„åœ°æ–¹ã€‚ğŸ˜„
<!--more-->
### èƒŒæ™¯
&nbsp;&nbsp;åŸŸååœ¨æ‰‹ä¸Šä¹Ÿæœ‰5ã€6å¹´äº†ï¼Œä¸€ç›´æ²¡æœ‰ä¸€ä¸ªæ­£å„¿å…«ç»çš„åšå®¢ã€‚ä»ä»¥å‰çš„csdnåˆ°åé¢çš„cnblogsï¼Œç„¶ååˆåˆ°WordPressï¼Œhexoï¼Œæœ€ååˆ°äº†hugoï¼Œå›æƒ³èµ·æ¥çœŸæ˜¯çš„ä¸€è·¯è‰°è¾›å•Šã€‚æ¯æ¬¡éƒ½æ˜¯æäº†ä¸€æ®µæ—¶é—´å°±å…³æ‰äº†ã€‚æœ€è¿‘åˆæ‰“ç®—é‡æ–°å¼€å§‹æï¼Œä¹Ÿæ–­æ–­ç»­ç»­æŠ˜è…¾äº†å¥½ä¹…ï¼Œä»2021å¹´åº•æŠ˜è…¾åˆ°è¿‡äº†å¹´2æœˆä»½éƒ½è¦è¿‡å®Œäº†ï¼Œç»ˆäºç®—æ˜¯æŠŠåšå®¢å®Œå…¨æå®šäº†ã€‚å¸Œæœ›è¿™æ¬¡èƒ½ä¸€ç›´åšæŒä¸‹æ¥ã€‚

&nbsp;&nbsp;æœ€è¿‘äº‹æƒ…ä¸€ç›´æ¯”è¾ƒå¿™ï¼Œå¿™ç€æ–°çš„ä¸€å¹´åˆ¶å®šè®¡åˆ’ï¼Œæ¨åŠ¨ä¸šåŠ¡ã€‚å®åœ¨æ˜¯æ²¡æœ‰å¤šå°‘ç²¾åŠ›æ¥æŠ˜è…¾åšå®¢ã€‚åªèƒ½æ¯å‘¨å‘¨æœ«ï¼Œæˆ–è€…æ¯å¤©ä¸å¤ªå¿™çš„æ—¶å€™ææã€‚ä»åŠ¨æ€åšå®¢è¿ç§»åˆ°é™æ€åšå®¢ä¹Ÿæ˜¯ä¸‹äº†ä¸€æ®µæ—¶é—´çš„å†³å¿ƒçš„ã€‚ä¸»è¦è€ƒè™‘è¿˜æ˜¯åŠ¨æ€åšå®¢è¿ç§»æ¯”è¾ƒéº»çƒ¦ã€‚æˆ‘åˆæ˜¯ä¸ªæ¯”è¾ƒçˆ±æŠ˜è…¾çš„äººï¼Œæ¯æ¬¡è¿ç§»æˆæœ¬ä¹Ÿæ˜¯æ¯”è¾ƒé«˜ã€‚å¹¶ä¸”ä¹Ÿæ²¡æœ‰markdownæ–¹ä¾¿ï¼Œåé¢æ”¹æˆé™æ€åšå®¢äº†ï¼Œåªè¦æ¢ä¸ªtheme,æ‰€æœ‰çš„åšæ–‡éƒ½åœ¨ï¼Œè¿™æ¬¡ä¹Ÿç®—æ˜¯ç¬¬ä¸€æ¬¡æé™æ€åšå®¢ï¼Œæ•´ä½“æä¸‹æ¥è¿˜æ˜¯æŒºæœ‰æ”¶è´§çš„ã€‚

### è°ƒç ”
&nbsp;&nbsp;ç¡®å®šè¦æ¢æˆé™æ€åšå®¢çš„æ—¶å€™è¿˜æ˜¯è°ƒç ”äº†å¥½å‡ æ¬¾ä¸é”™çš„å¼€æºåšå®¢ï¼Œä¾‹å¦‚hexoã€vuepressã€docsifyã€hugoã€‚æœ€åæœ¬åœ°ä¹Ÿæµ‹è¯•äº†å‡ æ¬¾è¿˜æ˜¯é€‰æ‹©äº†hugoã€‚ä¸€ä¸ªä¸»è¦çš„åŸå› æ˜¯æœ¬èº«å°±æ˜¯ååç«¯ä¾§çš„å¼€å‘ã€‚è€Œä¸”æœ€è¿‘ä¸»è¦æ˜¯åšgolangè¿™æ–¹é¢ï¼Œæ‰€ä»¥å…ˆå¤©å°±ä¼šæ¯”è¾ƒåå‘hugoã€‚å…¶ä»–çš„hexoå’Œdocsifyéƒ½æ˜¯nodejsçš„æŠ€æœ¯è·¯çº¿ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚vuepressæ˜¯æ¯”è¾ƒæ–°çš„é™æ€åšå®¢ç³»ç»Ÿã€‚ä¸è¿‡æ•´ä½“çœ‹ä¸‹æ¥è¿˜æ˜¯æ¯”è¾ƒå•ä¸€çš„ã€‚ç”¨çš„äººä¸å¤šã€‚

&nbsp;&nbsp;å½“ç„¶hugoä¹Ÿä¸æ˜¯åå…¨åç¾çš„ã€‚æœ€å¤§çš„é—®é¢˜å°±æ˜¯æ¨¡æ¿æ¯”è¾ƒå°‘ã€‚æ²¡æœ‰hexoé‚£ä¹ˆèŠ±å“¨ç»šä¸½çš„æ¨¡æ¿ã€‚ä¸€å¼€å§‹æˆ‘ç”¨çš„æ˜¯ [è€èµµ](https://www.zhaohuabing.com/) çš„ [hugo-theme-cleanwhite](https://github.com/zhaohuabing/hugo-theme-cleanwhite) æ¨¡æ¿ã€‚è¿˜ç»™è€èµµæäº†ä¸ªTwikooè¯„è®ºç»„ä»¶ã€‚ä¸è¿‡äººæ€»æ˜¯å–œæ¬¢æŠ˜è…¾ã€‚æœ€è¿‘æ¢äº†evenæ¨¡æ¿ã€‚æ•´ä½“ç®€æ´ä¸å°‘ã€‚è¿˜æ˜¯æ¯”è¾ƒå–œæ¬¢çš„ã€‚

### å‘å¸ƒæµç¨‹
&nbsp;&nbsp;æœ€åè¯´ä¸‹æˆ‘åšå®¢æ•´ä½“æ„å»ºå’Œå‘å¸ƒæ–¹æ¡ˆå§ã€‚å…¶å®ä¸€å¼€å§‹å°±æ˜¯æƒ³ç€æ¯æ¬¡æˆ‘åœ¨Markdownä¸Šå†™å¥½åšæ–‡åï¼Œé€šè¿‡github pushä¸Šå»åå°±ä¸ç”¨ç®¡äº†ï¼Œæ¥ä¸‹æ¥ä¸€å¥—ç¼–è¯‘æ‰“åŒ…æµç¨‹å°±ä¼šè‡ªåŠ¨å¤„ç†ã€‚å¥”ç€è¿™ä¸ªç›®æ ‡ä¹Ÿæ˜¯æŠ˜è…¾äº†ä¸å°‘æ—¶é—´ã€‚ä¸‹é¢å…·ä½“è¯´ä¸‹æ­¥éª¤ï¼š

#### 1ã€å»ºç«‹ä»“åº“
é¦–å…ˆè‚¯å®šæ˜¯è¦æœ‰ä¸ªgithub ä»“åº“çš„ã€‚ç”¨ä½œä½ çš„åšå®¢è½½ä½“ã€‚è¿™æ˜¯æˆ‘çš„[åšå®¢ä»“åº“](https://github.com/gwyy/myblog) ã€‚å¤§å®¶å¯ä»¥å‚è€ƒä¸‹ã€‚

#### 2ã€æ„å»ºworkflows
ä»£ç ä»“åº“é‡Œæ–°å»ºä¸€ä¸ª `.github` æ–‡ä»¶å¤¹ã€‚é‡Œé¢æ–°å»ºä¸ª `workflows` æ–‡ä»¶å¤¹ã€‚ç„¶åå»ºç«‹ä¸€ä¸ªç©ºçš„  yaml æ–‡ä»¶ã€‚ä½œä¸ºæ¯æ¬¡è§¦å‘github Actionsçš„é…ç½®æ–‡ä»¶ã€‚è‡³äºgithub Actions æ˜¯ä»€ä¹ˆ å¤§å®¶å¯ä»¥å‚è€ƒé˜®ä¸€å³°å¤§ç¥çš„è¿™ç¯‡æ–‡ç«  [GitHub Actions å…¥é—¨æ•™ç¨‹](https://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html)  ç®€å•è¯´ä¸‹å°±æ˜¯ç±»ä¼¼ä¸€ä¸ªé«˜çº§ç‰ˆçš„webhook, å¯ä»¥pushååšä¸€äº›ä½ æŒ‡å®šçš„äº‹æƒ…ã€‚ ä¸‹é¢çœ‹ä¸‹æˆ‘çš„workflows é…ç½®ã€‚
```shell
name: Blog
on:  #è§¦å‘å™¨
  push:  #æ¯æ¬¡ main pushçš„æ—¶å€™è§¦å‘
    branches: [ main ]
jobs:
  build:
    name: Blog  #æ‰§è¡Œåç§°
    runs-on: ubuntu-latest  #è¿è¡Œæ‰€éœ€è¦çš„è™šæ‹Ÿæœºç¯å¢ƒ
    timeout-minutes: 60
    steps:
    - name: Build Blog
      env:
        USER: ${{ secrets.SERVER_USER }}
        KEY: ${{ secrets.SERVER_KEY }}
        DOMAIN: ${{ secrets.SERVER_DOMAIN }}
      run: |
        mkdir ~/.ssh
        echo "$KEY" | tr -d '\r' > ~/.ssh/id_ed25519
        chmod 400 ~/.ssh/id_ed25519
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_ed25519
        ssh-keyscan -H $DOMAIN >> ~/.ssh/known_hosts
        ssh $USER@$DOMAIN "cd /root/wwwroot/myblog && /bin/bash deploy.sh"
```
æ•´ä½“ä»£ç å¾ˆç®€å•ï¼Œæˆ‘ä¹ŸåŠ äº†ä¸€äº›å¤‡æ³¨ï¼Œä¸»è¦å°±æ˜¯ä»£ç æ¨é€åˆ°githubä¹‹åï¼Œé€šè¿‡è®¾ç½®å¥½çš„ç”¨æˆ·åå’Œkey,è®©githubè¿œç¨‹é“¾æ¥æˆ‘çš„æœåŠ¡å™¨ï¼Œç„¶åè§¦å‘ `deploy.sh` è¿™ä¸ªshellã€‚å½“ç„¶äº†è¿™ä¸ªåŠŸèƒ½è¿œè¿œä¸æ­¢è¿™äº›ï¼Œå®ƒè¿˜å¯ä»¥å¸®ä½ dockeræ‰“åŒ…é•œåƒå¹¶ä¸”è‡ªåŠ¨æ¨é€åˆ°dockerHubã€‚åªä¸è¿‡è¿™é‡Œæˆ‘ä»…ä»…å½“åšä¸€ä¸ªé™¤è§¦å‘å™¨æ¥ä½¿ç”¨äº†ã€‚

#### 3ã€deploy
æœ€æ ¸å¿ƒçš„å°±æ˜¯æ‰§è¡Œdeploy.shç¯èŠ‚äº†ï¼Œå¤§è‡´åˆ†ä¸ºä¸‰å—ï¼š

##### 1ã€æ‹‰å–ä»£ç 
æ¸…ç†ä¸€äº›ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå’Œé™æ€åšå®¢ç›®å½•ï¼Œç„¶åæ‹‰å–æœ€æ–°ä»£ç ã€‚
```shell
# æ¸…ç†å·¥ä½œ
rm -rf public/
rm -rf blog
rm -rf resources/
#rm -rf node_modules
#rm -rf package-lock.json
# github pull
git fetch --all
git reset --hard origin/main
git pull
```
##### 2ã€ç¼–è¯‘ç¨‹åº
æ‰§è¡Œ hugo å‘½ä»¤ï¼Œç¼–è¯‘å‡ºåšå®¢æœ¬ä½“ï¼Œ --minifyæ˜¯å¼€å¯å‹ç¼©ã€‚ç„¶åç¼–è¯‘æ‰§è¡Œæˆ‘å†™çš„golangè„šæœ¬ï¼Œè¯¥è„šæœ¬åšçš„äº‹æƒ…å¾ˆç®€å•ã€‚ç›‘å¬3001ç«¯å£ï¼Œå¹¶ä¸”å¼€å¯ä¸€ä¸ªé™æ€çš„httpServerã€‚é‡Œé¢çš„å†…å®¹å°±æ˜¯æˆ‘çš„é™æ€åšå®¢
```shell
/root/repository/go/bin/hugo --minify
#/usr/local/bin/cnpm run algolia

# ç¼–è¯‘ä»£ç 
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 /usr/bin/go build -o blog
```
è„šæœ¬éƒ¨åˆ†ä»£ç 
```go
r := http.NewServeMux()
r.Handle("/", http.FileServer(http.Dir("/app/public")))
s := &http.Server{
    Addr:         addr,
    Handler:      logger(r),
    ReadTimeout:  30 * time.Second,
    WriteTimeout: time.Minute,
    IdleTimeout:  time.Minute,
}
```

##### 3ã€æ‰“åŒ…é•œåƒ
æœ€åä¸€æ­¥å°±æ˜¯æ‰§è¡Œå½“å‰ç›®å½•é‡Œçš„Dockerfileæ–‡ä»¶ç”Ÿæˆé•œåƒã€‚Dockerfileæ–‡ä»¶å†…å®¹ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠåˆšæ‰ç”Ÿæˆçš„é™æ€åšå®¢ç›®å½•å’Œåˆšæ‰ç¼–è¯‘çš„golangäºŒè¿›åˆ¶ç¨‹åºæ‹·è´åˆ°é•œåƒä½“å†…å°±å®Œæˆã€‚ ç„¶ådocker-compose å…³é—­å¹¶ä¸”æ¸…ç†æ‰é•œåƒã€‚æ¥ç€é‡æ–°å¯åŠ¨docker-composeã€‚æœ€ååšä¸‹æ¸…ç†å·¥ä½œã€‚
```shell
# ç”Ÿæˆdockeré•œåƒ
docker build  --tag myblog:latest .

#æ›´æ–°docker-compose
#ç¬¬ä¸€æ¬¡éœ€è¦å…ˆåˆ›å»ºç½‘ç»œ
docker-compose down
docker-compose up -d

#æ¸…ç†å·¥ä½œ åˆ é™¤tagä¸ºnoneçš„æ— ç”¨image
docker images | grep none | awk '{print $3}' | xargs docker rmi
docker system prune -f
```
è¿™é‡Œé‡ç‚¹è¯´ä¸‹docker-composeéƒ¨åˆ†ã€‚

docker-composeé‡Œä¼šå¯åŠ¨ä¸€ä¸ªå®ä¾‹æ¥å¯åŠ¨å½“å‰é•œåƒã€‚å¹¶ä¸”ä¼šæ‰“ä¸Šä¸€äº›traefikçš„æ ‡ç­¾ã€‚[traefik](https://doc.traefik.io/traefik/) æ˜¯ä¸€ä¸ªè¾¹ç¼˜è·¯ç”±ï¼Œå’Œdocker k8sæ·±åº¦ç»“åˆã€‚å¯ä»¥é€šè¿‡åŠ¨æ€é…ç½®ï¼Œåœ¨å®¹å™¨ä¸Šæ‰“æ ‡ç­¾çš„æ–¹å¼å°±èƒ½é…ç½®å¥½å¯¹åº”çš„è§„åˆ™ã€‚å¹¶ä¸”æ”¯æŒè‡ªåŠ¨ç”³è¯·httpsè¯ä¹¦ã€è‡ªåŠ¨ç»­è´¹çš„åŠŸèƒ½ã€‚

ä¸‹é¢çœ‹ä¸‹docker-compose.yamlå†…å®¹ï¼š
```shell
version: '3'
services:
  blog:
    image: myblog:latest
    restart: always
    networks:
      - proxy-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.test-http-cache.plugin.httpCache.maxTtl=600"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.blog.middlewares=redirect-to-https@docker"
      - "traefik.http.routers.blog.rule=Host(`liangtian.me`)"
      - "traefik.http.routers.blog.entrypoints=websecure"
      - "traefik.http.routers.blog.tls=true"
      - "traefik.http.routers.blog.tls.certresolver=letsencryptresolver"
      - "traefik.http.services.blog.loadbalancer.server.port=3001"

networks:
  proxy-net:
    external: true
```
å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘è¿™é‡Œåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘ç»œï¼Œè¿™æ ·æ¯æ¬¡å®¹å™¨ä¸Šçº¿åä¼šè§¦å‘traefikäº‹ä»¶ã€‚lablesé‡Œé¢å°±æ˜¯traefikçš„ä¸€äº›é…ç½®ï¼Œå¼€å¯äº†httpç¼“å­˜ï¼Œè®¾ç½®äº†httpsè§„åˆ™ç­‰ã€‚æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥ç ”ç©¶ä¸‹ã€‚

åˆ°è¿™é‡Œæ•´ä¸ªæµç¨‹å°±å®Œæˆäº†ã€‚è¿™å¥—æ–¹æ¡ˆçš„å¥½å¤„æ˜¯åŸºæœ¬ä¸Šä¸ä¾èµ–ä»»ä½•ä¸‰æ–¹ä¸­é—´ä»¶ã€‚ä»»æ„æ¢ä¸€å°æœåŠ¡å™¨åªè¦èƒ½å¤Ÿè¿æ¥ä¸Šgithubå’Œdockerhub åŸºæœ¬ä¸Šå°±èƒ½å¾ˆå¿«çš„è·‘èµ·æ¥æˆ‘çš„åšå®¢ã€‚å…¶å®å¯ä»¥æŠŠç¼–è¯‘å·¥ä½œçš„å‰åŠéƒ¨åˆ†golangæ‰“åŒ…éƒ¨åˆ†ä¹Ÿåšåˆ°github workflowsé‡Œï¼Œè¿™é‡Œå°±çœ‹å¤§å®¶æ€ä¹ˆå–œæ¬¢æ€ä¹ˆæ¥å°±å¥½äº†ã€‚

ä»Šå¤©å°±å…ˆå†™è¿™ä¹ˆå¤šå§ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¤§å®¶å¯ä»¥ç»™æˆ‘ç•™è¨€ã€‚ğŸ˜„

